<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard LoRa</title>

    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial, sans-serif;
        margin: 24px
      }
      h1 {
        margin: 0 0 8px 0
      }
      code {
        background-color: #f4f4f4;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 2px 6px;
        font-family: Consolas, "Courier New", monospace;
        font-size: 13px;
        color: #d63384;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 16px;
        margin: 12px 0;
        box-shadow: 0 2px 6px rgba(0,0,0,.06);
        transition: background-color 0.2s ease;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit,minmax(280px,1fr));
        gap: 12px
      }
      table {
        border-collapse: collapse;
        width: 100%
      }
      th, td {
        border-bottom: 1px solid #eee;
        padding: 8px;
        text-align: left;
        font-size: 14px
      }
      small { color:#666 }
      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
        margin-top: 8px;
        flex-wrap: wrap
      }
      input, select, button {
        padding: 8px;
        border: 1px solid #ccc;
        background-color: #f0f0f0;
        border-radius: 8px;
        transition: background-color 0.2s ease;
      }
      button:hover, select:hover {
        background-color: #dddddd;
        cursor: pointer;
      }
      .table-wrap {
        max-height: 420px;
        overflow: auto;
        border: 1px solid #eee;
        border-radius: 8px
      }
      thead th {
        position: sticky;
        top: 0;
        background: #fafafa
      }
      .badge {
        display: inline-block;
        padding: 2px 6px;
        border: 1px solid #e0e0e0;
        border-radius: 999px;
        background: #fafafa;
        margin-left: 6px;
        font-size: 12px
      }
      #seriesCanvas {
        width: 600px;
        height: 300px;
      }
      .auto-btn-on {
        background-color: #ca4a4a;
        color: white;
      }
      .auto-btn-off {
        background-color: #4CAF50;
        color: white;
      }
      .auto-btn-on:hover {
        background-color: #b82e2e;
        color: white;
      }
      .auto-btn-off:hover {
        background-color: #459948;
        color: white;
      }
    </style>
  </head>

  <body>
    <h1>Dashboard de Monitoramento LoRa</h1>

    <div class="card" style="display:flex; align-items:center; justify-content:space-between;">
      <div style="text-align:left;">
        <p style="margin: 0; margin-bottom: 8px;">
          Grupo 2: Eduardo Ferreira (190026987), Leonardo Cortês (200030582) e Rychard Ryan (190095229)
        </p>
        <p style="margin: 0; margin-top: 8px;">
          Leia o arquivo <code>README.md</code> para instruções de como executar o simulador<br>
        </p>
      </div>

      <button id="btnToggleAuto">Pausar Auto Update</button>

    </div>

    <div class="card">
      <h3>Série temporal de leituras</h3>
      <div class="controls">
        <label>Sala:</label>
        <select id="roomSelect"></select>

        <select id="metricSelect">
          <option value="temperatura">Temperatura (°C)</option>
          <option value="umidade">Umidade (%)</option>
          <option value="poeira">Poeira (µg/m³)</option>
        </select>

        <label>Registros:</label>
        <input id="seriesN" type="number" value="50" min="1" max="2000" style="width:100px">

        <button id="btnSeries">Carregar Série</button>

        <span id="seriesInfo" class="badge"></span>
      </div>
      <canvas id="seriesCanvas"></canvas>
    </div>

    <div class="card">
      <h3>Última leitura</h3>

      <div class="controls">
        <label>Sala:</label>
        <input id="roomFilter" placeholder="vazio = todas">

        <button id="btnLatest">Atualizar</button>
        <span id="latestInfo" class="badge"></span>
      </div>
      <div id="latest"></div>
    </div>

    <div class="card">
      <h3>Histórico de leituras</h3>

      <div class="controls">
        <label>Sala:</label>
        <select id="histRoom"></select>

        <label>Registros:</label>
        <input id="histN" type="number" value="50" min="1" max="1000" style="width:100px">

        <button id="btnHist">Carregar Histórico</button>

        <span id="histInfo" class="badge"></span>
      </div>

      <div class="table-wrap">
        <table id="histTable">
          <thead>
            <tr>
              <th>Data/Hora</th>
              <th>Sala</th>
              <th>Temperatura (°C)</th>
              <th>Umidade (%)</th>
              <th>Poeira (µg/m³)</th>
              <th>Seq</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <script>
      let autoRefresh = true;
      let refreshIntervalMs = 5000;
      let refreshTimer = null;

      let BASE = window.location.origin;

      function fmtDate(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        if (isNaN(d.getTime())) {
          const d2 = new Date(iso.replace(" ", "T"));
          return isNaN(d2.getTime()) ? iso : d2.toLocaleString();
        }
        return d.toLocaleString();
      }

      async function apiList({sala=null, limit=100}={}) {
        const url = new URL("/api/data", BASE);

        if (sala && sala.trim() !== "") url.searchParams.set("sala", sala);
        url.searchParams.set("limit", String(limit));

        const resp = await fetch(url.toString());
        if (!resp.ok) throw new Error("HTTP " + resp.status);

        return await resp.json();
      }

      async function refreshAll() {
        if (!autoRefresh) return;
        try {
          await loadLatest();
          await loadHistory();
          await loadSeries();
          document.getElementById("autoInfo").textContent = "auto update ativo";
        } catch (e) {
          console.error(e);
          document.getElementById("autoInfo").textContent = "erro no update";
        }
      }

      function updateAutoButton() {
        const btn = document.getElementById("btnToggleAuto");

        if (autoRefresh) {
          btn.textContent = "Pausar Auto Update";
          btn.classList.remove("auto-btn-off");
          btn.classList.add("auto-btn-on");
        } else {
          btn.textContent = "Retomar Auto Update";
          btn.classList.remove("auto-btn-on");
          btn.classList.add("auto-btn-off");
        }
      }

      document.getElementById("btnToggleAuto").addEventListener("click", () => {
        autoRefresh = !autoRefresh;
        updateAutoButton();
      });

      function salasDistintas(items) {
        const set = new Set();
        for (const it of items) if (it.sala) set.add(it.sala);

        return Array.from(set).sort();
      }

      function preencherSelectRooms(rooms) {
        const r1 = document.getElementById("roomSelect");
        const r2 = document.getElementById("histRoom");

        r1.innerHTML = "";
        r2.innerHTML = "";

        for (const s of rooms) {
          const o1 = document.createElement("option");
          o1.value = s; o1.textContent = s;
          const o2 = o1.cloneNode(true);

          r1.appendChild(o1);
          r2.appendChild(o2);
        }
      }

      function renderHistory(items) {
        const tbody = document.querySelector("#histTable tbody");
        tbody.innerHTML = "";

        for (const d of items) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${fmtDate(d.timestamp)}</td>
                          <td>${d.sala || "-"}</td>
                          <td>${d.temperatura}</td>
                          <td>${d.umidade}</td>
                          <td>${d.poeira}</td>
                          <td>${d.seq ?? "-"}</td>`;
          tbody.appendChild(tr);
        }
      }

      const SCALE_LIMITS = {
        temperatura: { min: -10, max: 40 },
        umidade:     { min: 0,   max: 100 },
        poeira:      { min: 0,   max: 100 }
      };

      function renderSeries(items, metricKey) {
        items = items.slice().reverse();
        const canvas = document.getElementById("seriesCanvas");
        const ctx = canvas.getContext("2d");
        const w = canvas.width = canvas.clientWidth;
        const h = canvas.height = canvas.clientHeight;

        ctx.clearRect(0, 0, w, h);

        const vals = items.map(i => Number(i[metricKey]));
        if (vals.length === 0 || vals.some(v => isNaN(v))) return;

        const min = SCALE_LIMITS[metricKey].min;
        const max = SCALE_LIMITS[metricKey].max;
        const minRead = Math.min(...vals);
        const maxRead = Math.max(...vals);
        const padLeft = 50;
        const padRight = 12;
        const padTop = 16;
        const padBottom = 20;
        const nx = vals.length - 1 || 1;

        ctx.font = "12px system-ui";
        ctx.fillStyle = "#000";
        ctx.strokeStyle = "#000";
        ctx.textAlign = "right";
        ctx.textBaseline = "middle";

        const ticks = 5;
        for (let i = 0; i <= ticks; i++) {
          const t = i / ticks;
          const value = min + (max - min) * (1 - t);
          const y = padTop + (h - padTop - padBottom) * t;

          ctx.beginPath();
          ctx.moveTo(padLeft - 5, y);
          ctx.lineTo(padLeft, y);
          ctx.stroke();

          ctx.fillText(value.toFixed(1), padLeft - 8, y);

          ctx.save();
          ctx.strokeStyle = "#eee";
          ctx.beginPath();
          ctx.moveTo(padLeft, y);
          ctx.lineTo(w - padRight, y);
          ctx.stroke();
          ctx.restore();
        }

        ctx.beginPath();
        ctx.moveTo(padLeft, padTop);
        ctx.lineTo(padLeft, h - padBottom);
        ctx.stroke();

        ctx.strokeStyle = "#000";
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let i = 0; i < vals.length; i++) {
          const x = padLeft + (w - padLeft - padRight) * (i / nx);
          const y = padTop + (h - padTop - padBottom) * (1 - (vals[i] - min) / (max - min || 1));
          if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        }
        ctx.stroke();

        ctx.textAlign = "left";
        ctx.textBaseline = "top";
        ctx.fillText(`   min ${minRead.toFixed(2)} | max ${maxRead.toFixed(2)}`, padLeft, 2);
      }

      function renderLatestMultiple(items) {
        const el = document.getElementById("latest");

        if (!items || items.length === 0) {
          el.innerHTML = "<small>Nenhuma leitura disponível.</small>";
          return;
        }

        let html = "<div class='grid'>";
        
        for (const item of items) {
          const alertaTemp = item.temperatura > 30;
          const alertaUmid = item.umidade < 30 || item.umidade > 70;
          const alertaPoeira = item.poeira > 80;

          const emAlerta = alertaTemp || alertaUmid || alertaPoeira;
          const estiloAlerta = emAlerta ? "background-color:#ffe5e5;border-color:#ff8080;" : "";

          let msgAlerta = "";
          if (emAlerta) {
            msgAlerta = "<small><b>Alerta:</b> condição fora do ideal.</small><br>";
          }

          html += `<div class='card' style="${estiloAlerta}">
            <b>${item.sala || "-"}</b><br>
            <small>${fmtDate(item.timestamp)}</small><br>
            ${msgAlerta}
            <table>
              <tr><th>Temperatura (°C)</th><td>${item.temperatura}</td></tr>
              <tr><th>Umidade (%)</th><td>${item.umidade}</td></tr>
              <tr><th>Poeira (µg/m³)</th><td>${item.poeira}</td></tr>
            </table>
          </div>`;
        }

        html += "</div>";
        el.innerHTML = html;
      }

      async function loadRoomsFromRecent() {
        const items = await apiList({limit: 200});
        const rooms = salasDistintas(items);

        preencherSelectRooms(rooms);

        return rooms;
      }

      async function loadSeries() {
        const sala = document.getElementById("roomSelect").value;
        const metric = document.getElementById("metricSelect").value;
        const n = parseInt(document.getElementById("seriesN").value || "50", 10);
        const data = await apiList({sala, limit: n});

        renderSeries(data, metric);

        document.getElementById("seriesInfo").textContent = `${sala} • ${metric} • ${data.length} pts`;
      }

      async function loadLatest() {
        const sala = document.getElementById("roomFilter").value.trim();
        let data = [];
        let message = "";

        if (sala) {
          data = await apiList({ sala, limit: 1 });
          if (data.length === 0) {
            document.getElementById("latest").innerHTML =
              `<small>Nenhuma leitura encontrada para a sala "<b>${sala}</b>".</small>`;
            document.getElementById("latestInfo").textContent = "sem resultados";
            return;
          }
          renderLatestMultiple(data);
          message = `Última leitura da sala "${sala}"`;
        } else {
          const all = await apiList({ sala: null, limit: 500 });
          const porSala = {};
          for (const item of all) {
            if (!porSala[item.sala]) porSala[item.sala] = item;
          }

          const ultimas = Object.keys(porSala)
            .sort((a, b) => a.localeCompare(b))
            .map(k => porSala[k]);

          renderLatestMultiple(ultimas);
          message = "Última leitura de cada sala";
        }

        document.getElementById("latestInfo").textContent = message;
      }

      async function loadHistory() {
        const sala = document.getElementById("histRoom").value;
        const n = parseInt(document.getElementById("histN").value || "50", 10);
        const data = await apiList({sala, limit: n});

        renderHistory(data);

        document.getElementById("histInfo").textContent = `${sala} • ${data.length} registros`;
      }

      document.getElementById("btnSeries").addEventListener("click", loadSeries);
      document.getElementById("btnLatest").addEventListener("click", loadLatest);
      document.getElementById("btnHist").addEventListener("click", loadHistory);

      async function boot() {
        const rooms = await loadRoomsFromRecent();
        if (rooms.length) {
          document.getElementById("roomSelect").value = rooms[0];
          document.getElementById("histRoom").value = rooms[0];
        }

        await loadSeries();
        await loadLatest();
        await loadHistory();

        updateAutoButton();
        refreshTimer = setInterval(refreshAll, refreshIntervalMs);
      }
      boot();
    </script>

  </body>
</html>